version: "3.9"

# =========
# MEGA / Chatwoot custom
# =========
services:
  # Redis usado pelo Chatwoot
  example_redis:
    image: redis:7.4.2
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis-data:/data

  # Aplicação web (porta interna 3000)
  mega_app:
    image: sendingtk/chatwoot:v4.7.2
    entrypoint: docker/entrypoints/rails.sh
    command: bundle exec rails s -p 3000 -b 0.0.0.0
    restart: unless-stopped
    depends_on:
      - example_redis
    volumes:
      - examplechat_dat:/app/storage
      # Se for usar branding, descomente e aponte os caminhos do host
      # - /opt/branding/mega/manifest.json:/app/public/manifest.json
      # - /opt/branding/mega/favicon.ico:/app/public/favicon.ico
      # ... (demais arquivos de branding)
    environment:
      # === Vars essenciais ===
      INSTALLATION_NAME: ${INSTALLATION_NAME:-ExampleChat}
      NODE_ENV: ${NODE_ENV:-production}
      RAILS_ENV: ${RAILS_ENV:-production}
      INSTALLATION_ENV: docker
      SECRET_KEY_BASE: ${SECRET_KEY_BASE:?defina_no_coolify}
      FRONTEND_URL: ${FRONTEND_URL:?defina_no_coolify}
      DEFAULT_LOCALE: ${DEFAULT_LOCALE:-en}
      FORCE_SSL: ${FORCE_SSL:-true}
      ENABLE_ACCOUNT_SIGNUP: ${ENABLE_ACCOUNT_SIGNUP:-false}

      # Redis e Postgres (DB externo ou do próprio Coolify, você decide)
      REDIS_URL: ${REDIS_URL:-redis://example_redis:6379}
      POSTGRES_HOST: ${POSTGRES_HOST:?defina_no_coolify}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_USERNAME: ${POSTGRES_USERNAME:?defina_no_coolify}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?defina_no_coolify}
      POSTGRES_DATABASE: ${POSTGRES_DATABASE:?defina_no_coolify}

      # Storage (padrão: local). Troque para S3/minio se quiser.
      ACTIVE_STORAGE_SERVICE: ${ACTIVE_STORAGE_SERVICE:-local}
      # Exemplo S3/minio (opcional):
      # S3_BUCKET_NAME: ${S3_BUCKET_NAME}
      # AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      # AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      # AWS_REGION: ${AWS_REGION}
      # STORAGE_BUCKET_NAME: ${STORAGE_BUCKET_NAME}
      # STORAGE_ACCESS_KEY_ID: ${STORAGE_ACCESS_KEY_ID}
      # STORAGE_SECRET_ACCESS_KEY: ${STORAGE_SECRET_ACCESS_KEY}
      # STORAGE_REGION: ${STORAGE_REGION}
      # STORAGE_ENDPOINT: ${STORAGE_ENDPOINT}
      # STORAGE_FORCE_PATH_STYLE: ${STORAGE_FORCE_PATH_STYLE}

      DIRECT_UPLOADS_ENABLED: ${DIRECT_UPLOADS_ENABLED:-true}
      RAILS_LOG_TO_STDOUT: ${RAILS_LOG_TO_STDOUT:-true}
      USE_INBOX_AVATAR_FOR_BOT: ${USE_INBOX_AVATAR_FOR_BOT:-true}

      # E-mail SMTP
      MAILER_SENDER_EMAIL: ${MAILER_SENDER_EMAIL:?defina_no_coolify}
      SMTP_DOMAIN: ${SMTP_DOMAIN:?defina_no_coolify}
      SMTP_ADDRESS: ${SMTP_ADDRESS:?defina_no_coolify}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USERNAME: ${SMTP_USERNAME:?defina_no_coolify}
      SMTP_PASSWORD: ${SMTP_PASSWORD:?defina_no_coolify}
      SMTP_AUTHENTICATION: ${SMTP_AUTHENTICATION:-login}
      SMTP_ENABLE_STARTTLS_AUTO: ${SMTP_ENABLE_STARTTLS_AUTO:-true}
      SMTP_OPENSSL_VERIFY_MODE: ${SMTP_OPENSSL_VERIFY_MODE:-peer}
      MAILER_INBOUND_EMAIL_DOMAIN: ${MAILER_INBOUND_EMAIL_DOMAIN:?defina_no_coolify}

      # Tuning
      SIDEKIQ_CONCURRENCY: ${SIDEKIQ_CONCURRENCY:-20}
      WEB_CONCURRENCY: ${WEB_CONCURRENCY:-2}
      RAILS_MAX_THREADS: ${RAILS_MAX_THREADS:-20}
      RACK_TIMEOUT_SERVICE_TIMEOUT: ${RACK_TIMEOUT_SERVICE_TIMEOUT:-0}
      ENABLE_RACK_ATTACK: ${ENABLE_RACK_ATTACK:-false}
      TZ: ${TZ:-UTC}
      ENABLE_PUSH_RELAY_SERVER: ${ENABLE_PUSH_RELAY_SERVER:-true}
      WEBHOOKS_TRIGGER_TIMEOUT: ${WEBHOOKS_TRIGGER_TIMEOUT:-40}

      # Integrações
      EVOLUTION_API_URL: ${EVOLUTION_API_URL}
      EVOLUTION_ADMIN_TOKEN: ${EVOLUTION_ADMIN_TOKEN}
      EVOLUTION_PUBLIC_S3: ${EVOLUTION_PUBLIC_S3:-false}
      WAHA_API_URL: ${WAHA_API_URL}
      WAHA_ADMIN_TOKEN: ${WAHA_ADMIN_TOKEN}
      UAZAPI_API_URL: ${UAZAPI_API_URL}
      UAZAPI_ADMIN_TOKEN: ${UAZAPI_ADMIN_TOKEN}

      # SSO (se usar)
      SSO: ${SSO:-false}

  # Worker (Sidekiq)
  mega_sidekiq:
    image: sendingtk/chatwoot:v4.7.2
    entrypoint: docker/entrypoints/rails.sh
    command: bundle exec sidekiq -C config/sidekiq.yml
    restart: unless-stopped
    depends_on:
      - example_redis
    volumes:
      - examplechat_dat:/app/storage
    environment:
      # Mesmas variáveis do app
      INSTALLATION_NAME: ${INSTALLATION_NAME:-ExampleChat}
      NODE_ENV: ${NODE_ENV:-production}
      RAILS_ENV: ${RAILS_ENV:-production}
      INSTALLATION_ENV: docker
      SECRET_KEY_BASE: ${SECRET_KEY_BASE:?defina_no_coolify}
      FRONTEND_URL: ${FRONTEND_URL:?defina_no_coolify}
      DEFAULT_LOCALE: ${DEFAULT_LOCALE:-en}
      FORCE_SSL: ${FORCE_SSL:-true}
      ENABLE_ACCOUNT_SIGNUP: ${ENABLE_ACCOUNT_SIGNUP:-false}
      REDIS_URL: ${REDIS_URL:-redis://example_redis:6379}
      POSTGRES_HOST: ${POSTGRES_HOST:?defina_no_coolify}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_USERNAME: ${POSTGRES_USERNAME:?defina_no_coolify}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?defina_no_coolify}
      POSTGRES_DATABASE: ${POSTGRES_DATABASE:?defina_no_coolify}
      ACTIVE_STORAGE_SERVICE: ${ACTIVE_STORAGE_SERVICE:-local}
      DIRECT_UPLOADS_ENABLED: ${DIRECT_UPLOADS_ENABLED:-true}
      RAILS_LOG_TO_STDOUT: ${RAILS_LOG_TO_STDOUT:-true}
      USE_INBOX_AVATAR_FOR_BOT: ${USE_INBOX_AVATAR_FOR_BOT:-true}
      MAILER_SENDER_EMAIL: ${MAILER_SENDER_EMAIL:?defina_no_coolify}
      SMTP_DOMAIN: ${SMTP_DOMAIN:?defina_no_coolify}
      SMTP_ADDRESS: ${SMTP_ADDRESS:?defina_no_coolify}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USERNAME: ${SMTP_USERNAME:?defina_no_coolify}
      SMTP_PASSWORD: ${SMTP_PASSWORD:?defina_no_coolify}
      SMTP_AUTHENTICATION: ${SMTP_AUTHENTICATION:-login}
      SMTP_ENABLE_STARTTLS_AUTO: ${SMTP_ENABLE_STARTTLS_AUTO:-true}
      SMTP_OPENSSL_VERIFY_MODE: ${SMTP_OPENSSL_VERIFY_MODE:-peer}
      MAILER_INBOUND_EMAIL_DOMAIN: ${MAILER_INBOUND_EMAIL_DOMAIN:?defina_no_coolify}
      SIDEKIQ_CONCURRENCY: ${SIDEKIQ_CONCURRENCY:-20}
      WEB_CONCURRENCY: ${WEB_CONCURRENCY:-2}
      RAILS_MAX_THREADS: ${RAILS_MAX_THREADS:-20}
      RACK_TIMEOUT_SERVICE_TIMEOUT: ${RACK_TIMEOUT_SERVICE_TIMEOUT:-0}
      ENABLE_RACK_ATTACK: ${ENABLE_RACK_ATTACK:-false}
      TZ: ${TZ:-UTC}
      ENABLE_PUSH_RELAY_SERVER: ${ENABLE_PUSH_RELAY_SERVER:-true}
      WEBHOOKS_TRIGGER_TIMEOUT: ${WEBHOOKS_TRIGGER_TIMEOUT:-40}
      EVOLUTION_API_URL: ${EVOLUTION_API_URL}
      EVOLUTION_ADMIN_TOKEN: ${EVOLUTION_ADMIN_TOKEN}
      EVOLUTION_PUBLIC_S3: ${EVOLUTION_PUBLIC_S3:-false}
      WAHA_API_URL: ${WAHA_API_URL}
      WAHA_ADMIN_TOKEN: ${WAHA_ADMIN_TOKEN}
      UAZAPI_API_URL: ${UAZAPI_API_URL}
      UAZAPI_ADMIN_TOKEN: ${UAZAPI_ADMIN_TOKEN}
      SSO: ${SSO:-false}

volumes:
  examplechat_dat:
  redis-data:
